<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ç²¾åº¦OCRãƒ„ãƒ¼ãƒ«ï¼šè¦‹é–‹ããƒ»é‡è¤‡è‡ªå‹•å‡¦ç†ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background-color: #f5f5f7; color: #1d1d1f; }
        h2 { text-align: center; color: #333; margin-bottom: 30px; font-weight: 700; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        strong.label { display: block; margin-bottom: 12px; color: #0071e3; font-size: 1.1em; }
        
        .important-note { font-size: 0.85em; color: #1d1d1f; background: #ffffff; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #d2d2d7; line-height: 1.6; }
        .important-note a { color: #0071e3; text-decoration: underline; font-weight: bold; }

        input, select { width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px; font-size: 14px; background: #fafafa; }
        .range-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .range-container input { width: 80px; margin-bottom: 0; text-align: center; }

        button { background-color: #0071e3; color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px; transition: 0.2s; }
        button:hover { background-color: #0077ed; transform: translateY(-1px); }
        
        #log { background: #ffffff; color: #333; padding: 15px; border: 1px solid #d2d2d7; border-radius: 8px; height: 150px; overflow-y: auto; font-size: 13px; line-height: 1.6; }
        
        textarea { width: 100%; height: 500px; border: 1px solid #d2d2d7; border-radius: 8px; padding: 15px; font-size: 15px; line-height: 1.8; margin-top: 10px; resize: vertical; box-sizing: border-box; display: block; }
        
        .copy-btn { width: auto; font-size: 13px; padding: 8px 16px; margin-bottom: 10px; background-color: #34c759; }
        .log-error { color: #ff3b30; font-weight: bold; }
        .log-retry { color: #f5a623; font-weight: bold; }
        .log-success { color: #34c759; font-weight: bold; }
        footer { text-align: center; margin-top: 40px; padding: 20px; font-size: 0.8em; color: #86868b; }
    </style>
</head>
<body>

    <h2>æ—¥æœ¬èªæ›¸ç± é«˜ç²¾åº¦OCR</h2>

    <div class="card">
        <strong class="label">1. è¨­å®š</strong>
        <input type="password" id="apiKey" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
        <select id="modelSelect">
            <option value="gemini-2.0-flash">Gemini 2.0 Flash (é«˜é€Ÿãƒ»æ¨å¥¨)</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro (æœ€é«˜ç²¾åº¦)</option>
        </select>
        <button id="saveKeyBtn">è¨­å®šã‚’ä¿å­˜</button>
    </div>

    <div class="card">
        <strong class="label">2. å®Ÿè¡Œè¨­å®š</strong>
        <input type="file" id="pdfFile" accept="application/pdf">
        <div class="range-container">
            <input type="number" id="startPage" value="1" min="1">
            <span>ãƒšãƒ¼ã‚¸ã‹ã‚‰</span>
            <input type="number" id="endPage" placeholder="æœ€å¾Œ" min="1">
            <span>ãƒšãƒ¼ã‚¸ã¾ã§</span>
        </div>
        <button id="startBtn">OCRå‡¦ç†ã‚’é–‹å§‹ï¼ˆè‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¤å®šä»˜ï¼‰</button>
    </div>

    <div class="card">
        <strong class="label">3. é€²è¡ŒçŠ¶æ³</strong>
        <div id="log">PDFã‚’é¸æŠã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div class="card">
        <strong class="label">4. çµæœ</strong>
        <button id="copyBtn" class="copy-btn">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <textarea id="result" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const logArea = document.getElementById('log');
        const resultArea = document.getElementById('result');
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelect = document.getElementById('modelSelect');
        const startPageInput = document.getElementById('startPage');
        const endPageInput = document.getElementById('endPage');

        // è¨­å®šã®èª­ã¿è¾¼ã¿
        apiKeyInput.value = localStorage.getItem('gemini_api_key') || "";
        modelSelect.value = localStorage.getItem('gemini_model_choice') || "gemini-2.0-flash";

        document.getElementById('saveKeyBtn').onclick = () => {
            localStorage.setItem('gemini_api_key', apiKeyInput.value);
            localStorage.setItem('gemini_model_choice', modelSelect.value);
            alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        };

        const addLog = (msg, type = '') => {
            const div = document.createElement('div');
            if (type === 'error') div.className = 'log-error';
            if (type === 'retry') div.className = 'log-retry';
            if (type === 'success') div.className = 'log-success';
            div.innerHTML = msg;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        };

        document.getElementById('startBtn').onclick = async () => {
            const file = document.getElementById('pdfFile').files[0];
            const key = apiKeyInput.value;
            if (!file || !key) { alert("PDFã¨APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚"); return; }
            
            logArea.innerHTML = "";
            resultArea.value = "";

            try {
                const genAI = new GoogleGenerativeAI(key);
                const model = genAI.getGenerativeModel({ model: modelSelect.value });
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                
                const actualStart = Math.max(1, parseInt(startPageInput.value) || 1);
                const actualEnd = Math.min(pdf.numPages, parseInt(endPageInput.value) || pdf.numPages);

                for (let i = actualStart; i <= actualEnd; i++) {
                    addLog(`[${i}/${actualEnd}] è§£æä¸­...`);
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale: 3.0}); // é«˜è§£åƒåº¦ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({canvasContext: ctx, viewport: viewport}).promise;

                    // 1. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¤å®š
                    const fullPageB64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    let layoutType = "SINGLE";
                    try {
                        const layoutCheck = await model.generateContent([
                            { inlineData: { data: fullPageB64, mimeType: "image/jpeg" } },
                            "ã“ã®ç”»åƒã¯ã€Œä¸€æ®µçµ„ï¼ˆ1ãƒšãƒ¼ã‚¸æ§‹æˆï¼‰ã€ã§ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ã€ŒäºŒæ®µçµ„ï¼ˆè¦‹é–‹ãï¼‰ã€ã§ã™ã‹ï¼Ÿ 'SINGLE' ã¾ãŸã¯ 'DOUBLE' ã¨ã ã‘è¿”ã—ã¦ãã ã•ã„ã€‚"
                        ]);
                        layoutType = layoutCheck.response.text().toUpperCase();
                    } catch (e) { addLog("  åˆ¤å®šã‚¨ãƒ©ãƒ¼ã€ä¸€æ®µçµ„ã¨ã—ã¦å‡¦ç†ã—ã¾ã™", 'retry'); }

                    // 2. OCRç”¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½œæˆ
                    let contents = [];
                    let prompt = "";

                    if (layoutType.includes("DOUBLE")) {
                        addLog(`  -> äºŒæ®µçµ„åˆ¤å®šï¼šå·¦å³ã«åˆ†å‰²ã—ã¦é‡è¤‡ã‚’é™¤å»ã—ã¾ã™ã€‚`);
                        const mid = canvas.width / 2;
                        const margin = Math.floor(canvas.width * 0.06); // å°‘ã—åºƒã‚ã«ã®ã‚Šã—ã‚ã‚’å–ã‚‹

                        const rCanvas = document.createElement('canvas');
                        rCanvas.width = canvas.width - (mid - margin); rCanvas.height = canvas.height;
                        rCanvas.getContext('2d').drawImage(canvas, mid - margin, 0, rCanvas.width, canvas.height, 0, 0, rCanvas.width, canvas.height);
                        
                        const lCanvas = document.createElement('canvas');
                        lCanvas.width = mid + margin; lCanvas.height = canvas.height;
                        lCanvas.getContext('2d').drawImage(canvas, 0, 0, lCanvas.width, canvas.height, 0, 0, lCanvas.width, canvas.height);

                        contents.push({ inlineData: { data: rCanvas.toDataURL('image/jpeg', 0.8).split(',')[1], mimeType: "image/jpeg" } });
                        contents.push({ inlineData: { data: lCanvas.toDataURL('image/jpeg', 0.8).split(',')[1], mimeType: "image/jpeg" } });
                        
                        prompt = `æŒ‡ç¤ºï¼šæç¤ºã•ã‚ŒãŸ2æšã®ç”»åƒã¯æ›¸ç±ã®è¦‹é–‹ãï¼ˆå³ãƒšãƒ¼ã‚¸ã¨å·¦ãƒšãƒ¼ã‚¸ï¼‰ã§ã™ã€‚ä¸­å¤®éƒ¨ãŒé‡è¤‡ã—ã¦ã„ã¾ã™ã€‚
                        1. å³ã‹ã‚‰å·¦ã¸ã¨ç¶šãä¸€æœ¬ã®æ–‡ç« ã¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¦ãã ã•ã„ã€‚
                        2. ã€æœ€é‡è¦ã€‘ä¸­å¤®ã®é‡è¤‡éƒ¨åˆ†ã¯ã€æ–‡è„ˆã‚’åˆ¤æ–­ã—ã¦äºŒé‡ã«å‡ºåŠ›ã›ãšã€è‡ªç„¶ã«ç¹‹ã’ã¦ãã ã•ã„ã€‚
                        3. ç‰©ç†çš„ãªæ”¹è¡Œã¯é™¤å»ã—ã€æ„å‘³çš„ãªæ®µè½ã®ã¿ã§æ”¹è¡Œã—ã¦ãã ã•ã„ã€‚
                        4. æŸ±ã€ãƒãƒ³ãƒ–ãƒ«ã€ãƒã‚¤ã‚ºã¯é™¤å¤–ã—ã¦ãã ã•ã„ã€‚
                        5. å‡ºåŠ›ã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã€‚`;
                    } else {
                        addLog(`  -> ä¸€æ®µçµ„åˆ¤å®šï¼šå…¨ä½“ã‚’ãã®ã¾ã¾å‡¦ç†ã—ã¾ã™ã€‚`);
                        contents.push({ inlineData: { data: fullPageB64, mimeType: "image/jpeg" } });
                        prompt = "æŒ‡ç¤ºï¼šæ—¥æœ¬èªæ›¸ç±ï¼ˆç¸¦æ›¸ãï¼‰ã®è¶…é«˜ç²¾åº¦ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã¨è«–ç†æ§‹é€ ã®å†æ§‹ç¯‰

1. å½¹å‰²
ã‚ãªãŸã¯ã€å›½ç«‹å›½ä¼šå›³æ›¸é¤¨ã®ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åŒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¾“äº‹ã™ã‚‹ã€ä¸–ç•Œæœ€é«˜å³°ã®ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚æç¤ºã•ã‚ŒãŸç”»åƒï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã•ã‚ŒãŸæ—¥æœ¬èªã®ç¸¦æ›¸ããƒ»è¦‹é–‹ãæ›¸ç±ï¼‰ã‚’èª­ã¿å–ã‚Šã€**æ›¸ç±ã®ç‰©ç†çš„ãªè¡ŒåŒºåˆ‡ã‚Šã§ã¯ãªãã€è‘—è€…ãŒæ„å›³ã—ãŸè«–ç†çš„ãªæ–‡ç« æ§‹é€ ã¨ã—ã¦**ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¦ãã ã•ã„ã€‚

2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã®ç†è§£
* **æ–‡ç« ã®é€£çµï¼ˆæœ€é‡è¦ï¼‰**: æ›¸ç±ä¸Šã®ç‰©ç†çš„ãªæ”¹è¡Œä½ç½®ã§ã¯**çµ¶å¯¾ã«æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œãªã„ã§ãã ã•ã„**ã€‚è¡Œæœ«ã¨æ¬¡è¡Œã®è¡Œé ­ã¯ã€é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œãšã«é€£çµã—ã€ä¸€ã¤ã®æ–‡ã¨ã—ã¦ç¶šã‘ã¦ãã ã•ã„ã€‚
* **æ®µè½ã®æ‰±ã„**: æ”¹è¡Œã‚’è¡Œã†ã®ã¯ã€**ã€Œæ®µè½ãŒå¤‰ã‚ã‚‹ç®‡æ‰€ï¼ˆé€šå¸¸ã€æ–‡é ­ãŒä¸€å­—ä¸‹ãŒã£ã¦ã„ã‚‹ç®‡æ‰€ï¼‰ã€**ãŠã‚ˆã³ã€Œè¦‹å‡ºã—ã€ã®å‰å¾Œã®ã¿ã¨ã—ã¦ãã ã•ã„ã€‚

3. å…·ä½“çš„ãªå‡¦ç†è¦å‰‡
* **æ–‡å­—èªè­˜**: å¸¸ç”¨æ¼¢å­—ã€æ—§å­—ä½“ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€å¥èª­ç‚¹ã‚’æ­£ç¢ºã«è­˜åˆ¥ã—ã¦ãã ã•ã„ã€‚
* **ãƒã‚¤ã‚ºã®é™¤å»**: ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆãƒãƒ³ãƒ–ãƒ«ï¼‰ã€ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæŸ±ï¼‰ã€ãƒ•ãƒƒã‚¿ãƒ¼ã¯æœ¬æ–‡ã®æ–‡è„ˆã‚’åˆ†æ–­ã™ã‚‹ãŸã‚ã€**å‡ºåŠ›ã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã—ã¦ãã ã•ã„**ã€‚
* **æ¨è«–ã«ã‚ˆã‚‹è£œå®Œ**: ã‚¹ã‚­ãƒ£ãƒ³ã®æ­ªã¿ã‚„ç¶´ã˜éƒ¨åˆ†ã®å½±ã§æ–‡å­—ãŒä¸é®®æ˜ãªå ´åˆã‚„æ˜ã‚‰ã‹ãªOCRã‚¨ãƒ©ãƒ¼ã¯ã€å‰å¾Œã®æ–‡è„ˆã‹ã‚‰æ—¥æœ¬èªã¨ã—ã¦æœ€ã‚‚è‡ªç„¶ãªæ–‡å­—ã‚’æ¨è«–ã—ã¦åŸ‹ã‚ã¦ãã ã•ã„ã€‚
* **ãƒ«ãƒ“ãƒ»å›³è¡¨**: æœ¬æ–‡ã®è‡ªç„¶ãªæµã‚Œã‚’é˜»å®³ã—ãªã„ã‚ˆã†ã€ãƒ«ãƒ“ã‚„å›³è¡¨å†…ã®æ–‡å­—ã¯èª­ã¿é£›ã°ã—ã¦ãã ã•ã„ã€‚
* **ä¸è¦ãªç©ºç™½ã®å‰Šé™¤**: æ–‡å­—é–“ã®ä¸è‡ªç„¶ãªã‚¹ãƒšãƒ¼ã‚¹ã¯ã™ã¹ã¦å‰Šé™¤ã—ã€è©°ã‚ã¦è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

4. å‡ºåŠ›å½¢å¼
å‡ºåŠ›ã¯ç´”ç²‹ãªtextå½¢å¼ã¨ã—ã€æŒ¨æ‹¶ã‚„è§£èª¬ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚";
                    }

                    // 3. å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ï¼‰
                    let success = false;
                    for (let attempt = 0; attempt < 3; attempt++) {
                        try {
                            const result = await model.generateContent([...contents, prompt]);
                            const text = result.response.text();
                            resultArea.value += `--- Page ${i} ---\n${text}\n\n`;
                            resultArea.scrollTop = resultArea.scrollHeight;
                            success = true;
                            break;
                        } catch (err) {
                            addLog(`  [!] ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã€å†è©¦è¡Œä¸­... (${attempt+1}/3)`, 'retry');
                            await new Promise(r => setTimeout(r, 2000 * (attempt + 1)));
                        }
                    }
                    if (!success) addLog(`  [x] ãƒšãƒ¼ã‚¸ ${i} ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ`, 'error');
                    
                    addLog(`[${i}/${actualEnd}] å®Œäº†`, 'success');
                    await new Promise(r => setTimeout(r, 1200)); // è² è·è»½æ¸›
                }
                addLog("å…¨å·¥ç¨‹ãŒå®Œäº†ã—ã¾ã—ãŸï¼", 'success');
            } catch (err) { addLog("ã‚¨ãƒ©ãƒ¼: " + err.message, 'error'); }
        };

        document.getElementById('copyBtn').onclick = () => {
            resultArea.select();
            document.execCommand('copy');
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        };
    </script>
</body>
</html>
