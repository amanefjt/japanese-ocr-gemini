<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    window.startOCR = async () => {
        // ...（初期設定部分は同じ）...
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({scale: 2.5}); // 高解像度にする
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({canvasContext: context, viewport: viewport}).promise;

            // --- 左右に分割してGeminiに投げる ---
            const mid = canvas.width / 2;
            const margin = canvas.width * 0.05; // 5%の重なり

            // 右側のCanvasを作成
            const rightCanvas = document.createElement('canvas');
            rightCanvas.width = mid + margin;
            rightCanvas.height = canvas.height;
            rightCanvas.getContext('2d').drawImage(canvas, mid - margin, 0, mid + margin, canvas.height, 0, 0, mid + margin, canvas.height);

            // 左側のCanvasを作成
            const leftCanvas = document.createElement('canvas');
            leftCanvas.width = mid + margin;
            leftCanvas.height = canvas.height;
            leftCanvas.getContext('2d').drawImage(canvas, 0, 0, mid + margin, canvas.height, 0, 0, mid + margin, canvas.height);

            const parts = [
                { name: "右段", data: rightCanvas.toDataURL('image/jpeg', 0.8).split(',')[1] },
                { name: "左段", data: leftCanvas.toDataURL('image/jpeg', 0.8).split(',')[1] }
            ];

            for (const part of parts) {
                const prompt = `これは縦書きで、一段組または二段組文書の「${part.name}」です。物理的な改行を繋ぎ、意味的な段落を維持してテキスト化してください。`;
                try {
                    const result = await model.generateContent([
                        prompt,
                        { inlineData: { data: part.data, mimeType: "image/jpeg" } }
                    ]);
                    resultArea.value += result.response.text() + "\n";
                } catch (e) {
                    console.error(e);
                }
                await new Promise(r => setTimeout(r, 2000)); // 2秒待機
            }
        }
    };
</script>
