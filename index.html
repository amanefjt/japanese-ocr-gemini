<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬èªç¸¦æ›¸ãPDFã‚’Geminiã§OCRã™ã‚‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f5f5f7; color: #1d1d1f; }
        h2 { text-align: center; color: #333; margin-bottom: 30px; font-weight: 700; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        strong.label { display: block; margin-bottom: 12px; color: #0071e3; font-size: 1.1em; }
        
        /* èª¬æ˜æ–‡ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼šç´°ãã€ç›®ç«‹ãŸã›ã™ããªã„ */
        .description { font-size: 0.85em; line-height: 1.5; color: #6e6e73; margin-bottom: 8px; font-weight: 400; }
        .description a { color: #0071e3; text-decoration: none; border-bottom: 1px solid rgba(0,113,227,0.3); }
        .description a:hover { border-bottom: 1px solid #0071e3; }
        
        .safe-info { font-size: 0.8em; color: #86868b; margin-top: 4px; margin-bottom: 12px; display: flex; align-items: flex-start; gap: 4px; line-height: 1.4; }

        input[type="password"], input[type="file"] { width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px; font-size: 14px; background: #fafafa; }
        input[type="password"]:focus { outline: none; border-color: #0071e3; background: #fff; }

        button { background-color: #0071e3; color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px; transition: all 0.2s; }
        button:hover { background-color: #0077ed; transform: translateY(-1px); }
        
        /* é€²è¡ŒçŠ¶æ³ï¼šç™½èƒŒæ™¯ã«é»’æ–‡å­— */
        #log { background: #ffffff; color: #333; padding: 15px; border: 1px solid #d2d2d7; border-radius: 8px; font-family: inherit; height: 120px; overflow-y: auto; font-size: 13px; line-height: 1.6; }
        
        /* æ›¸ãèµ·ã“ã—çµæœ */
        textarea { width: 100%; height: 500px; border: 1px solid #d2d2d7; border-radius: 8px; padding: 15px; font-size: 15px; line-height: 1.8; box-sizing: border-box; margin-top: 10px; resize: vertical; background-color: #fff; }
        
        .log-error { color: #ff3b30; font-weight: bold; }
        .log-success { color: #34c759; font-weight: bold; }
    </style>
</head>
<body>

    <h2>æ—¥æœ¬èªç¸¦æ›¸ãPDFã‚’Geminiã§OCRã™ã‚‹</h2>

    <div class="card">
        <strong class="label">1. è¨­å®šï¼ˆGemini APIã‚­ãƒ¼ï¼‰</strong>
        
        <div class="description">
            ğŸ”‘ <strong>Gemini APIã‚­ãƒ¼ã®å–å¾—:</strong> 
            <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>ã§å–å¾—ã§ãã¾ã™ã€‚é€šå¸¸ã®åˆ©ç”¨ï¼ˆ1æ—¥æ•°ç™¾ãƒšãƒ¼ã‚¸ç¨‹åº¦ï¼‰ã§ã‚ã‚Œã°ç„¡æ–™ã§å‡¦ç†å¯èƒ½ã§ã™ã€‚
        </div>

        <input type="password" id="apiKey" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›">
        
        <div class="safe-info">
            ğŸ›¡ï¸ <span><strong>å®‰å…¨æ€§ã¨ãƒ‡ãƒ¼ã‚¿ã®æ‰±ã„:</strong> å…¥åŠ›ã—ãŸã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã€ä½œè€…ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚ç„¡æ–™æ ã§ã¯å…¥åŠ›å†…å®¹ãŒãƒ¢ãƒ‡ãƒ«æ”¹å–„ã«åˆ©ç”¨ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</span>
        </div>

        <button id="saveKeyBtn">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong class="label">2. OCRã‚’å®Ÿè¡Œã™ã‚‹PDFã‚’é¸æŠ</strong>
        <input type="file" id="pdfFile" accept="application/pdf">
        <button id="startBtn">OCRå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong class="label">3. é€²è¡ŒçŠ¶æ³</strong>
        <div id="log">PDFã‚’é¸æŠã—ã¦é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div class="card">
        <strong class="label">4. æ›¸ãèµ·ã“ã—çµæœ</strong>
        <textarea id="result" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
    </div>

    <script type="module">
        // Gemini SDK ã®èª­ã¿è¾¼ã¿
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // PDF.js ãƒ¯ãƒ¼ã‚«ãƒ¼ã®è¨­å®š
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const logArea = document.getElementById('log');
        const resultArea = document.getElementById('result');
        const apiKeyInput = document.getElementById('apiKey');

        // ãƒ­ã‚°å‡ºåŠ›ç”¨é–¢æ•°
        const addLog = (msg, type = '') => {
            const div = document.createElement('div');
            if (type === 'error') div.className = 'log-error';
            if (type === 'success') div.className = 'log-success';
            div.innerHTML = msg;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        };

        // APIã‚­ãƒ¼ã®èª­ã¿è¾¼ã¿ã¨ä¿å­˜
        apiKeyInput.value = localStorage.getItem('gemini_api_key') || "";
        document.getElementById('saveKeyBtn').onclick = () => {
            localStorage.setItem('gemini_api_key', apiKeyInput.value);
            alert("è¨­å®šã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
        };

        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        document.getElementById('startBtn').onclick = async () => {
            const file = document.getElementById('pdfFile').files[0];
            const key = apiKeyInput.value;

            if (!file || !key) {
                alert("PDFãƒ•ã‚¡ã‚¤ãƒ«ã¨APIã‚­ãƒ¼ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚");
                return;
            }

            logArea.innerHTML = "";
            addLog(`å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™: ${file.name}`);
            resultArea.value = "";

            try {
                const genAI = new GoogleGenerativeAI(key);
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                addLog(`PDFèª­ã¿è¾¼ã¿æˆåŠŸ: å…¨ ${pdf.numPages} ãƒšãƒ¼ã‚¸`);

                for (let i = 1; i <= pdf.numPages; i++) {
                    addLog(`[${i}/${pdf.numPages}] ãƒšãƒ¼ã‚¸ã‚’è§£æä¸­...`);
                    const page = await pdf.getPage(i);
                    // OCRç²¾åº¦å‘ä¸Šã®ãŸã‚é«˜è§£åƒåº¦ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    const viewport = page.getViewport({scale: 2.5});
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({canvasContext: ctx, viewport: viewport}).promise;
                    
                    // å·¦å³ã«åˆ†å‰²ï¼ˆäºŒæ®µçµ„å¯¾å¿œï¼‰
                    const mid = canvas.width / 2;
                    const margin = canvas.width * 0.05;
                    const sides = [
                        { name: "å³æ®µ", x: mid - margin, w: mid + margin },
                        { name: "å·¦æ®µ", x: 0, w: mid + margin }
                    ];

                    let pageText = `--- Page ${i} ---\n`;

                    for (const side of sides) {
                        const sCanvas = document.createElement('canvas');
                        sCanvas.width = side.w; sCanvas.height = canvas.height;
                        sCanvas.getContext('2d').drawImage(canvas, side.x, 0, side.w, canvas.height, 0, 0, side.w, canvas.height);
                        
                        const base64Data = sCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        
                        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                        const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®ç·¨é›†è€…ã§ã™ã€‚ã“ã®ç”»åƒï¼ˆç¸¦æ›¸ãã§ä¸€æ®µçµ„ã€ã¾ãŸã¯äºŒæ®µçµ„ã®${side.name}ï¼‰ã‚’æ­£ç¢ºã«æ›¸ãèµ·ã“ã—ã¦ãã ã•ã„ã€‚ç‰©ç†çš„ãªè¡Œæœ«ã®æ”¹è¡Œã¯ç¹‹ã’ã€æ„å‘³çš„ãªæ®µè½ï¼ˆä¸€æ–‡å­—ä¸‹ã’ç­‰ï¼‰ã®åŒºåˆ‡ã‚Šã ã‘æ”¹è¡Œã—ã¦ãã ã•ã„ã€‚æœ¬æ–‡ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

                        const result = await model.generateContent([
                            { inlineData: { data: base64Data, mimeType: "image/jpeg" } },
                            prompt
                        ]);

                        pageText += result.response.text() + "\n";
                    }

                    // çµæœã‚’ç”»é¢ã«è¿½åŠ 
                    resultArea.value += pageText + "\n";
                    resultArea.scrollTop = resultArea.scrollHeight;
                    addLog(`[${i}/${pdf.numPages}] å®Œäº†`, 'success');

                    // 1ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«2ç§’å¾…æ©Ÿï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
                    await new Promise(r => setTimeout(r, 2000));
                }
                addLog("ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", 'success');

            } catch (err) {
                addLog("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message, 'error');
                console.error(err);
            }
        };
    </script>
</body>
</html>
