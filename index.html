<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬èªè¦‹é–‹ãç¸¦æ›¸ãPDFã®OCR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f5f5f7; color: #1d1d1f; }
        h2 { text-align: center; color: #333; margin-bottom: 30px; font-weight: 700; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; }
        strong.label { display: block; margin-bottom: 12px; color: #0071e3; font-size: 1.1em; }
        
        .important-note { font-size: 0.85em; color: #1d1d1f; background: #ffffff; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #d2d2d7; line-height: 1.6; }
        .important-note a { color: #0071e3; text-decoration: underline; font-weight: bold; }
        
        .comparison-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin: 15px 0; background: #f9f9fb; }
        .comparison-table th, .comparison-table td { border: 1px solid #d2d2d7; padding: 8px; text-align: center; }
        .comparison-table th { background: #f0f0f4; font-weight: 600; }

        input, select { width: 100%; padding: 12px; border: 1px solid #d2d2d7; border-radius: 8px; box-sizing: border-box; margin-bottom: 8px; font-size: 14px; background: #fafafa; }
        .range-container { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .range-container input { width: 80px; margin-bottom: 0; text-align: center; }

        button { background-color: #0071e3; color: white; border: none; padding: 14px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px; transition: 0.2s; }
        button:hover { background-color: #0077ed; transform: translateY(-1px); }
        
        .copy-btn { width: auto; font-size: 13px; padding: 8px 16px; margin-bottom: 10px; background-color: #34c759; }
        .copy-success { font-size: 12px; color: #34c759; margin-left: 10px; font-weight: bold; opacity: 0; transition: 0.3s; }

        #log { background: #ffffff; color: #333; padding: 15px; border: 1px solid #d2d2d7; border-radius: 8px; height: 120px; overflow-y: auto; font-size: 13px; line-height: 1.6; }
        textarea { width: 100%; height: 500px; border: 1px solid #d2d2d7; border-radius: 8px; padding: 15px; font-size: 15px; line-height: 1.8; margin-top: 10px; resize: vertical; }
        
        .warning-box { background: #fffdf5; border: 1px solid #f0e6cc; padding: 8px 12px; border-radius: 6px; font-size: 0.75em; color: #665c3d; margin: 10px 0; }
        .log-error { color: #ff3b30; font-weight: bold; }
        .log-retry { color: #f5a623; font-weight: bold; }
        .log-success { color: #34c759; font-weight: bold; }

        footer { text-align: center; margin-top: 40px; padding: 20px; font-size: 0.8em; color: #86868b; border-top: 1px solid #e5e5e7; }
    </style>
</head>
<body>

    <h2>æ—¥æœ¬èªè¦‹é–‹ãç¸¦æ›¸ãPDFã®OCR</h2>

    <div class="card">
        <strong class="label">1. è¨­å®šï¼ˆAPIã‚­ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ï¼‰</strong>
        
        <input type="password" id="apiKey" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">

        <div class="important-note">
            ã“ã®ãƒ„ãƒ¼ãƒ«ã¯Gemini APIã®<strong>ç„¡æ–™æ å†…ã§ä½¿ãˆã¾ã™ã€‚</strong><br><br>
            ğŸ”‘ <strong>Gemini APIã‚­ãƒ¼ã«ã¤ã„ã¦:</strong> <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>ã§å–å¾—ã§ãã¾ã™ã€‚ç„¡æ–™æ ã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã§ã™ãŒã€Googleã®ä»•æ§˜ä¸Šã€<strong>æ”¯æ‰•ã„æ‰‹æ®µã®ç™»éŒ²ãŒå¿…è¦</strong>ã§ã™ã€‚ç™»éŒ²ã—ãŸAPIã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã€ãƒ„ãƒ¼ãƒ«åˆ¶ä½œè€…ã«ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“ã€‚<br>
            âš ï¸ <strong>å­¦ç¿’ã¸ã®åˆ©ç”¨ã«ã¤ã„ã¦:</strong> ç„¡æ–™æ ã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯Googleã®ãƒ¢ãƒ‡ãƒ«æ”¹å–„ã®ãŸã‚ã«å­¦ç¿’ã«åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ©Ÿå¯†æ€§ã®é«˜ã„è³‡æ–™ã‚’æ‰±ã†éš›ã¯ã”æ³¨æ„ãã ã•ã„ã€‚
        </div>
        
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>ãƒ¢ãƒ‡ãƒ«</th>
                    <th>1æ—¥ã®ä¸Šé™ç›®å®‰</th>
                    <th>ç‰¹å¾´</th>
                </tr>
            </thead>
            <tbody>
                <tr><td><strong>2.5 Flash</strong></td><td>ç´„5,000æš</td><td><strong>é«˜ç²¾åº¦</strong>ãƒ»è¤‡é›‘ãªç´™é¢å‘ã</td></tr>
                <tr><td><strong>2.0 Flash</strong></td><td>ç´„1,500æš</td><td><strong>çˆ†é€Ÿ</strong>ãƒ»å¤§é‡å‡¦ç†å‘ã</td></tr>
            </tbody>
        </table>

        <select id="modelSelect">
            <option value="gemini-2.5-flash">Gemini 2.5 Flash (æ¨å¥¨)</option>
            <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        </select>
        <button id="saveKeyBtn">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong class="label">2. å®Ÿè¡Œè¨­å®š</strong>
        <input type="file" id="pdfFile" accept="application/pdf">
        
        <div class="warning-box">
            âš ï¸ ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’é¿ã‘ã‚‹ãŸã‚ã€ä¸€åº¦ã«100ãƒšãƒ¼ã‚¸ç¨‹åº¦ãšã¤ã®å‡¦ç†ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
        </div>

        <div class="range-container">
            <input type="number" id="startPage" value="1" min="1">
            <span>ãƒšãƒ¼ã‚¸ã‹ã‚‰</span>
            <input type="number" id="endPage" placeholder="æœ€å¾Œ" min="1">
            <span>ãƒšãƒ¼ã‚¸ã¾ã§</span>
        </div>
        <button id="startBtn">OCRå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong class="label">3. é€²è¡ŒçŠ¶æ³</strong>
        <div id="log">PDFã‚’é¸æŠã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div class="card">
        <strong class="label">4. æ›¸ãèµ·ã“ã—çµæœ</strong>
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <button id="copyBtn" class="copy-btn">ğŸ“‹ å…¨ã¦ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
            <span id="copyMsg" class="copy-success">ã‚³ãƒ”ãƒ¼å®Œäº†ï¼</span>
        </div>
        <textarea id="result" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
    </div>

    <footer>
        
    </footer>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const logArea = document.getElementById('log');
        const resultArea = document.getElementById('result');
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelect = document.getElementById('modelSelect');
        const startPageInput = document.getElementById('startPage');
        const endPageInput = document.getElementById('endPage');
        const copyBtn = document.getElementById('copyBtn');
        const copyMsg = document.getElementById('copyMsg');

        apiKeyInput.value = localStorage.getItem('gemini_api_key') || "";
        modelSelect.value = localStorage.getItem('gemini_model_choice') || "gemini-2.5-flash";

        document.getElementById('saveKeyBtn').onclick = () => {
            localStorage.setItem('gemini_api_key', apiKeyInput.value);
            localStorage.setItem('gemini_model_choice', modelSelect.value);
            alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        };

        copyBtn.onclick = async () => {
            if (!resultArea.value) return;
            await navigator.clipboard.writeText(resultArea.value);
            copyMsg.style.opacity = "1";
            setTimeout(() => { copyMsg.style.opacity = "0"; }, 2000);
        };

        const addLog = (msg, type = '') => {
            const div = document.createElement('div');
            if (type === 'error') div.className = 'log-error';
            if (type === 'retry') div.className = 'log-retry';
            if (type === 'success') div.className = 'log-success';
            div.innerHTML = msg;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        };

        document.getElementById('startBtn').onclick = async () => {
            const file = document.getElementById('pdfFile').files[0];
            const key = apiKeyInput.value;
            const selectedModel = modelSelect.value;
            if (!file || !key) { alert("PDFã¨APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚"); return; }
            
            logArea.innerHTML = "";
            resultArea.value = "";

            try {
                const genAI = new GoogleGenerativeAI(key);
                const model = genAI.getGenerativeModel({ model: selectedModel });
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                
                const actualStart = Math.max(1, parseInt(startPageInput.value) || 1);
                const actualEnd = Math.min(pdf.numPages, parseInt(endPageInput.value) || pdf.numPages);

                for (let i = actualStart; i <= actualEnd; i++) {
                    addLog(`[${i}/${actualEnd}] ãƒšãƒ¼ã‚¸å‡¦ç†ä¸­...`);
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({scale: 2.5});
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({canvasContext: ctx, viewport: viewport}).promise;
                    
                    const mid = canvas.width / 2;
                    const margin = Math.floor(canvas.width * 0.05); // Pythonç‰ˆ(5%)ã®ç§»æ¤
                    
                    // Pythonç‰ˆã®åº§æ¨™æŒ‡å®šãƒ­ã‚¸ãƒƒã‚¯
                    const sides = [
                        { name: "å³å´", x: mid - margin, w: canvas.width - (mid - margin) },
                        { name: "å·¦å´", x: 0, w: mid + margin }
                    ];

                    let pageText = `--- Page ${i} ---\n`;
                    for (const side of sides) {
                        const sCanvas = document.createElement('canvas');
                        sCanvas.width = side.w; sCanvas.height = canvas.height;
                        sCanvas.getContext('2d').drawImage(canvas, side.x, 0, side.w, canvas.height, 0, 0, side.w, canvas.height);
                        const base64Data = sCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        
                        // Pythonç‰ˆã®æœ€å¼·ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
                        const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®æ ¡æ­£è€…ã§ã™ã€‚æç¤ºã•ã‚ŒãŸç”»åƒï¼ˆæ—¥æœ¬èªãƒ»ç¸¦æ›¸ãã®${side.name}ï¼‰ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¦ãã ã•ã„ã€‚

ã€æœ€å„ªå…ˆãƒ«ãƒ¼ãƒ«ã€‘
1. æ–‡ç« ã‚’ç¹‹ã’ã‚‹: 1è¡Œã”ã¨ã®ç‰©ç†çš„ãªæ”¹è¡Œã¯ã™ã¹ã¦å‰Šé™¤ã—ã€ä¸€ã¤ã®æ„å‘³ã®é€šã‚‹æ–‡ç« ã¨ã—ã¦ç¹‹ã’ã¦ãã ã•ã„ã€‚
2. æ®µè½ã®ç¶­æŒ: æ–‡é ­ãŒä¸€æ–‡å­—ä¸‹ãŒã£ã¦ã„ã‚‹ç®‡æ‰€ã‚„ã€æ˜ç¢ºãªè©±é¡Œã®åˆ‡ã‚Šæ›¿ã‚ã‚ŠãŒã‚ã‚‹ç®‡æ‰€ã®ã¿ã€æ”¹è¡Œï¼ˆæ®µè½åˆ†ã‘ï¼‰ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
3. ã‚´ãƒŸã®æ’é™¤: ãƒšãƒ¼ã‚¸ç«¯ã®ãƒã‚¤ã‚ºã‚„ã€åŠåˆ†åˆ‡ã‚Œã¦ã„ã‚‹éš£ã®æ®µã®æ–‡å­—ã¯å®Œå…¨ã«ç„¡è¦–ã—ã¦ãã ã•ã„ã€‚
4. æœ¬æ–‡ã®ã¿: è§£èª¬ã‚„ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ä¸€åˆ‡å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚`;

                        // === ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ (Pythonç‰ˆã®ç§»æ¤) ===
                        let success = false;
                        let maxRetries = 3;
                        for (let attempt = 0; attempt < maxRetries; attempt++) {
                            try {
                                const result = await model.generateContent([{ inlineData: { data: base64Data, mimeType: "image/jpeg" } }, prompt]);
                                pageText += result.response.text() + "\n";
                                success = true;
                                break;
                            } catch (err) {
                                const msg = err.message || "";
                                if (msg.includes("429") || msg.includes("RESOURCE_EXHAUSTED") || msg.includes("503")) {
                                    const waitSec = 30 * (attempt + 1);
                                    addLog(`  [!] ${side.name}: åˆ¶é™ä¸­... ${waitSec}ç§’å¾…æ©Ÿ (${attempt + 1}/${maxRetries})`, 'retry');
                                    await new Promise(r => setTimeout(r, waitSec * 1000));
                                } else {
                                    addLog(`  [x] ${side.name}ã§ã‚¨ãƒ©ãƒ¼: ${msg.substring(0, 50)}`, 'error');
                                    break;
                                }
                            }
                        }
                        await new Promise(r => setTimeout(r, 1000)); // åŸºæœ¬å¾…æ©Ÿ
                    }
                    resultArea.value += pageText + "\n";
                    resultArea.scrollTop = resultArea.scrollHeight;
                    addLog(`[${i}/${actualEnd}] å®Œäº†`, 'success');
                }
                addLog("ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", 'success');
            } catch (err) { addLog("é‡å¤§ãªã‚¨ãƒ©ãƒ¼: " + err.message, 'error'); }
        };
    </script>
</body>
</html>
