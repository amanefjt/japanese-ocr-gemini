<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æœ¬èªç¸¦æ›¸ãPDFã®OCR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            position: relative;
        }

        strong.label {
            display: block;
            margin-bottom: 12px;
            color: #0071e3;
            font-size: 1.1em;
        }

        .important-note {
            font-size: 0.85em;
            color: #1d1d1f;
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #d2d2d7;
            line-height: 1.6;
        }

        .important-note a {
            color: #0071e3;
            text-decoration: underline;
            font-weight: bold;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            margin: 15px 0;
            background: #f9f9fb;
        }

        .comparison-table th,
        .comparison-table td {
            border: 1px solid #d2d2d7;
            padding: 8px;
            text-align: center;
        }

        .comparison-table th {
            background: #f0f0f4;
            font-weight: 600;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            box-sizing: border-box;
            margin-bottom: 8px;
            font-size: 14px;
            background: #fafafa;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .range-container input {
            width: 80px;
            margin-bottom: 0;
            text-align: center;
        }

        button {
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            font-size: 16px;
            transition: 0.2s;
        }

        button:hover {
            background-color: #0077ed;
            transform: translateY(-1px);
        }

        /* 4. æ›¸ãèµ·ã“ã—çµæœ ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .result-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 5px;
        }

        .copy-btn {
            width: auto;
            font-size: 13px;
            padding: 8px 16px;
            margin-bottom: 10px;
            background-color: #34c759;
        }

        .copy-success {
            font-size: 12px;
            color: #34c759;
            margin-left: 10px;
            font-weight: bold;
            opacity: 0;
            transition: 0.3s;
        }

        #log {
            background: #ffffff;
            color: #333;
            padding: 15px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            height: 120px;
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        /* ãƒœãƒƒã‚¯ã‚¹ã¯ã¿å‡ºã—é˜²æ­¢ä¿®æ­£ */
        textarea {
            width: 100%;
            height: 500px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            padding: 15px;
            font-size: 15px;
            line-height: 1.8;
            margin-top: 10px;
            resize: vertical;
            box-sizing: border-box;
            display: block;
        }

        .warning-box {
            background: #fffdf5;
            border: 1px solid #f0e6cc;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75em;
            color: #665c3d;
            margin: 10px 0;
        }

        .log-error {
            color: #ff3b30;
            font-weight: bold;
        }

        .log-retry {
            color: #f5a623;
            font-weight: bold;
        }

        .log-success {
            color: #34c759;
            font-weight: bold;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            font-size: 0.8em;
            color: #86868b;
            border-top: 1px solid #e5e5e7;
        }
    </style>
</head>

<body>

    <h2>æ—¥æœ¬èªç¸¦æ›¸ãPDFã®OCR</h2>

    <div class="card">
        <strong class="label">1. è¨­å®šï¼ˆAPIã‚­ãƒ¼ã¨ãƒ¢ãƒ‡ãƒ«ï¼‰</strong>

        <input type="password" id="apiKey" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">

        <div class="important-note">
            ã“ã®ãƒ„ãƒ¼ãƒ«ã¯Gemini APIã®<strong>ç„¡æ–™æ å†…ã§ä½¿ãˆã¾ã™ã€‚</strong><br><br>
            ğŸ”‘ <strong>Gemini APIã‚­ãƒ¼ã«ã¤ã„ã¦:</strong> <a href="https://aistudio.google.com/app/apikey"
                target="_blank">Google AI
                Studio</a>ã§å–å¾—ã§ãã¾ã™ã€‚ç„¡æ–™æ ã§åˆ©ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ã§ã™ãŒã€Googleã®ä»•æ§˜ä¸Šã€<strong>æ”¯æ‰•ã„æ‰‹æ®µã®ç™»éŒ²ãŒå¿…è¦</strong>ã§ã™ã€‚ç™»éŒ²ã—ãŸAPIã¯ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã€ãƒ„ãƒ¼ãƒ«åˆ¶ä½œè€…ã«ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“ã€‚<br>
            âš ï¸ <strong>å­¦ç¿’ã¸ã®åˆ©ç”¨ã«ã¤ã„ã¦:</strong>
            ç„¡æ–™æ ã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯Googleã®ãƒ¢ãƒ‡ãƒ«æ”¹å–„ã®ãŸã‚ã«å­¦ç¿’ã«åˆ©ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ©Ÿå¯†æ€§ã®é«˜ã„è³‡æ–™ã‚’æ‰±ã†éš›ã¯ã”æ³¨æ„ãã ã•ã„ã€‚
        </div>

        <table class="comparison-table">
            <thead>
                <tr>
                    <th>ãƒ¢ãƒ‡ãƒ«</th>
                    <th>1æ—¥ã®ä¸Šé™ç›®å®‰</th>
                    <th>ç‰¹å¾´</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>3 Flash Preview</strong></td>
                    <td>ç´„1,500æš</td>
                    <td><strong>æœ€å…ˆç«¯</strong>ãƒ»æ¬¡ä¸–ä»£ã®è§£æèƒ½åŠ›</td>
                </tr>
                <tr>
                    <td><strong>2.5 Flash</strong></td>
                    <td>ç´„5,000æš</td>
                    <td><strong>é«˜ç²¾åº¦</strong>ãƒ»è¤‡é›‘ãªç´™é¢å‘ã</td>
                </tr>
            </tbody>
        </table>

        <select id="modelSelect">
            <option value="gemini-3-flash-preview">Gemini 3 Flash Preview (æ¨å¥¨)</option>
            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«åã‚’å…¥åŠ›...</option>
        </select>
        <input type="text" id="customModelInput" placeholder="ä¾‹: gemini-1.5-pro"
            style="display: none; margin-top: 5px;">
        <button id="saveKeyBtn">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong class="label">2. å®Ÿè¡Œè¨­å®š</strong>
        <input type="file" id="pdfFile" accept="application/pdf">

        <strong class="label" style="font-size: 0.9em; margin-top: 15px;">æ–‡æ›¸ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</strong>
        <div style="margin-bottom: 15px;">
            <label style="margin-right: 15px;">
                <input type="radio" name="layout" value="two-column" checked style="width: auto;"> äºŒæ®µçµ„ï¼ˆè‡ªå‹•åˆ†å‰²ï¼‰
            </label>
            <label>
                <input type="radio" name="layout" value="one-column" style="width: auto;"> ä¸€æ®µçµ„ï¼ˆåˆ†å‰²ãªã—ï¼‰
            </label>
        </div>

        <div class="range-container">
            <input type="number" id="startPage" value="1" min="1">
            <span>ãƒšãƒ¼ã‚¸ã‹ã‚‰</span>
            <input type="number" id="endPage" placeholder="æœ€å¾Œ" min="1">
            <span>ãƒšãƒ¼ã‚¸ã¾ã§</span>
        </div>
        <div class="warning-box">
            âš ï¸ ãƒ¡ãƒ¢ãƒªåˆ¶é™ã‚’é¿ã‘ã‚‹ãŸã‚ã€ä¸€åº¦ã«100ãƒšãƒ¼ã‚¸ç¨‹åº¦ãšã¤ã®å‡¦ç†ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
        </div>
        
        <button id="startBtn">OCRå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong class="label">3. é€²è¡ŒçŠ¶æ³</strong>
        <div id="log">PDFã‚’é¸æŠã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div class="card">
        <strong class="label">4. æ›¸ãèµ·ã“ã—çµæœ</strong>
        <div class="result-header">
            <button id="copyBtn" class="copy-btn">ğŸ“‹ å…¨ã¦ã‚³ãƒ”ãƒ¼ã™ã‚‹</button>
            <span id="copyMsg" class="copy-success">ã‚³ãƒ”ãƒ¼å®Œäº†ï¼</span>
        </div>
        <textarea id="result" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
    </div>

    <footer>
        äººæ–‡ç¤¾ä¼šç§‘å­¦ç³»ã®ãŸã‚ã®ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ„ãƒ¼ãƒ«
    </footer>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const logArea = document.getElementById('log');
        const resultArea = document.getElementById('result');
        const apiKeyInput = document.getElementById('apiKey');
        const modelSelect = document.getElementById('modelSelect');
        const startPageInput = document.getElementById('startPage');
        const endPageInput = document.getElementById('endPage');
        const copyBtn = document.getElementById('copyBtn');
        const copyMsg = document.getElementById('copyMsg');

        apiKeyInput.value = localStorage.getItem('gemini_api_key') || "";
        modelSelect.value = localStorage.getItem('gemini_model_choice') || "gemini-3-flash-preview";

        // Show custom input if selected
        if (modelSelect.value === 'custom') {
            const customInput = document.getElementById('customModelInput');
            if (customInput) customInput.style.display = 'block';
        }

        document.getElementById('saveKeyBtn').onclick = () => {
            localStorage.setItem('gemini_api_key', apiKeyInput.value);
            localStorage.setItem('gemini_model_choice', modelSelect.value);
            alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        };

        copyBtn.onclick = async () => {
            if (!resultArea.value) return;
            try {
                await navigator.clipboard.writeText(resultArea.value);
                const originalText = copyBtn.innerText;
                copyBtn.innerText = "âœ… ã‚³ãƒ”ãƒ¼å®Œäº†ï¼";
                copyBtn.style.backgroundColor = "#28a745";

                setTimeout(() => {
                    copyBtn.innerText = originalText;
                    copyBtn.style.backgroundColor = "";
                }, 2000);
            } catch (err) {
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
            }
        };

        const addLog = (msg, type = '') => {
            const div = document.createElement('div');
            if (type === 'error') div.className = 'log-error';
            if (type === 'retry') div.className = 'log-retry';
            if (type === 'success') div.className = 'log-success';
            div.innerHTML = msg;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        };

        // High Precision Prompt (Hardcoded)
        const OCR_PROMPT = `æŒ‡ç¤ºï¼šæ—¥æœ¬èªæ›¸ç±ï¼ˆç¸¦æ›¸ãï¼‰ã®è¶…é«˜ç²¾åº¦ãƒ†ã‚­ã‚¹ãƒˆåŒ–

1. å½¹å‰²
ã‚ãªãŸã¯ã€å›½ç«‹å›½ä¼šå›³æ›¸é¤¨ã®ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–åŒ–ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¾“äº‹ã™ã‚‹ã€ä¸–ç•Œæœ€é«˜å³°ã®ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚æç¤ºã•ã‚ŒãŸç”»åƒï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã•ã‚ŒãŸæ—¥æœ¬èªã®ç¸¦æ›¸ãã®{side}éƒ¨åˆ†ï¼‰ã‚’ã€ä¸€æ–‡å­—ã®å¦¥å”ã‚‚ãªãã€å…ƒã®æ–‡ç« ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å®Œå…¨ã«ç¶­æŒã—ãŸçŠ¶æ…‹ã§ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ã¦ãã ã•ã„ã€‚

2. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã®ç†è§£
* **é‡è¤‡ã®æ’é™¤ï¼ˆé‡è¦ï¼‰**: è¦‹é–‹ãç”»åƒã®åˆ†å‰²å‡¦ç†ã«ãŠã„ã¦ã€ä¸­å¤®éƒ¨åˆ†ï¼ˆãƒãƒ‰ï¼‰ä»˜è¿‘ã®æ–‡ç« ãŒå·¦å³ã®ç”»åƒã§é‡è¤‡ã—ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å ´åˆã€é‡è¤‡éƒ¨åˆ†ã‚’æ¤œå‡ºã—ã€**ä¸€åº¦ã ã‘**å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼ˆäºŒé‡ã«å‡ºåŠ›ã—ãªã„ã“ã¨ï¼‰ã€‚
* **æ–‡ç« ã®é€£çµï¼ˆæœ€é‡è¦ï¼‰**: æ›¸ç±ä¸Šã®ç‰©ç†çš„ãªæ”¹è¡Œä½ç½®ã§ã¯**çµ¶å¯¾ã«æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œãªã„ã§ãã ã•ã„**ã€‚è¡Œæœ«ã¨æ¬¡è¡Œã®è¡Œé ­ã¯ã€é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ã‚’å…¥ã‚Œãšã«é€£çµã—ã€ä¸€ã¤ã®æ–‡ã¨ã—ã¦ç¶šã‘ã¦ãã ã•ã„ã€‚
* **æ®µè½ã®æ‰±ã„**: æ”¹è¡Œã‚’è¡Œã†ã®ã¯ã€**ã€Œæ®µè½ãŒå¤‰ã‚ã‚‹ç®‡æ‰€ï¼ˆé€šå¸¸ã€æ–‡é ­ãŒä¸€å­—ä¸‹ãŒã£ã¦ã„ã‚‹ç®‡æ‰€ï¼‰ã€**ãŠã‚ˆã³ã€Œè¦‹å‡ºã—ã€ã®å‰å¾Œã®ã¿ã¨ã—ã¦ãã ã•ã„ã€‚

3. å…·ä½“çš„ãªå‡¦ç†è¦å‰‡
* **æ–‡å­—èªè­˜**: å¸¸ç”¨æ¼¢å­—ã€æ—§å­—ä½“ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€å¥èª­ç‚¹ã‚’æ­£ç¢ºã«è­˜åˆ¥ã—ã¦ãã ã•ã„ã€‚
* **ãƒã‚¤ã‚ºã®é™¤å»**: ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆãƒãƒ³ãƒ–ãƒ«ï¼‰ã€ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæŸ±ï¼‰ã€ãƒ•ãƒƒã‚¿ãƒ¼ã¯æœ¬æ–‡ã®æ–‡è„ˆã‚’åˆ†æ–­ã™ã‚‹ãŸã‚ã€**å‡ºåŠ›ã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã—ã¦ãã ã•ã„**ã€‚
* **æ¨è«–ã«ã‚ˆã‚‹è£œå®Œ**: ã‚¹ã‚­ãƒ£ãƒ³ã®æ­ªã¿ã‚„ç¶´ã˜éƒ¨åˆ†ã®å½±ã§æ–‡å­—ãŒä¸é®®æ˜ãªå ´åˆã‚„æ˜ã‚‰ã‹ãªOCRã‚¨ãƒ©ãƒ¼ã¯ã€å‰å¾Œã®æ–‡è„ˆã‹ã‚‰æ—¥æœ¬èªã¨ã—ã¦æœ€ã‚‚è‡ªç„¶ãªæ–‡å­—ã‚’æ¨è«–ã—ã¦åŸ‹ã‚ã¦ãã ã•ã„ã€‚
* **ãƒ«ãƒ“ãƒ»å›³è¡¨**: æœ¬æ–‡ã®è‡ªç„¶ãªæµã‚Œã‚’é˜»å®³ã—ãªã„ã‚ˆã†ã€ãƒ«ãƒ“ã‚„å›³è¡¨å†…ã®æ–‡å­—ã¯èª­ã¿é£›ã°ã—ã¦ãã ã•ã„ã€‚
* **ä¸è¦ãªç©ºç™½ã®å‰Šé™¤**: æ–‡å­—é–“ã®ä¸è‡ªç„¶ãªã‚¹ãƒšãƒ¼ã‚¹ã¯ã™ã¹ã¦å‰Šé™¤ã—ã€è©°ã‚ã¦è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

4. å‡ºåŠ›å½¢å¼
å‡ºåŠ›ã¯ç´”ç²‹ãªtextå½¢å¼ã¨ã—ã€æŒ¨æ‹¶ã‚„è§£èª¬ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚`;

        document.getElementById('startBtn').onclick = async (e) => {
            const startBtn = e.target;
            const file = document.getElementById('pdfFile').files[0];
            const key = apiKeyInput.value;
            const selectedModel = modelSelect.value;
            if (!file || !key) { alert("PDFã¨APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚"); return; }

            startBtn.disabled = true;
            startBtn.innerText = "â³ å‡¦ç†ä¸­...";
            startBtn.style.opacity = "0.7";

            logArea.innerHTML = "";
            resultArea.value = "";

            try {
                const genAI = new GoogleGenerativeAI(key);
                let modelName = selectedModel;
                if (selectedModel === 'custom') {
                    const customInput = document.getElementById('customModelInput');
                    if (customInput && customInput.value) {
                        modelName = customInput.value.trim();
                    } else {
                        alert("ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                        startBtn.disabled = false;
                        startBtn.innerText = "OCRå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹";
                        startBtn.style.opacity = "1";
                        return;
                    }
                }
                const model = genAI.getGenerativeModel({ model: modelName });

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                const actualStart = Math.max(1, parseInt(startPageInput.value) || 1);
                const actualEnd = Math.min(pdf.numPages, parseInt(endPageInput.value) || pdf.numPages);

                // Get Layout Setting
                const layout = document.querySelector('input[name="layout"]:checked').value;

                for (let i = actualStart; i <= actualEnd; i++) {
                    addLog(`[${i}/${actualEnd}] ãƒšãƒ¼ã‚¸å‡¦ç†ä¸­...`);
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.5 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    let imagesToProcess = [];

                    if (layout === 'two-column') {
                        // === äºŒæ®µçµ„ï¼ˆåˆ†å‰²ã‚ã‚Šï¼‰ ===
                        // ãƒãƒ‰å…ƒã§å·¦å³ãŒç¹‹ãŒã£ã¦ã—ã¾ã†ã®ã‚’é˜²ããŸã‚ã€ç‰©ç†çš„ã«åˆ†å‰²ã—ã¦å‡¦ç†ã™ã‚‹
                        const mid = canvas.width / 2;
                        const margin = Math.floor(canvas.width * 0.05);

                        // å³å´
                        const sCanvasRight = document.createElement('canvas');
                        sCanvasRight.width = canvas.width - (mid - margin);
                        sCanvasRight.height = canvas.height;
                        sCanvasRight.getContext('2d').drawImage(canvas, mid - margin, 0, sCanvasRight.width, canvas.height, 0, 0, sCanvasRight.width, canvas.height);

                        // å·¦å´
                        const sCanvasLeft = document.createElement('canvas');
                        sCanvasLeft.width = mid + margin;
                        sCanvasLeft.height = canvas.height;
                        sCanvasLeft.getContext('2d').drawImage(canvas, 0, 0, sCanvasLeft.width, canvas.height, 0, 0, sCanvasLeft.width, canvas.height);

                        imagesToProcess.push({ name: "å³å´", base64: sCanvasRight.toDataURL('image/jpeg', 0.8).split(',')[1] });
                        imagesToProcess.push({ name: "å·¦å´", base64: sCanvasLeft.toDataURL('image/jpeg', 0.8).split(',')[1] });

                    } else {
                        // === ä¸€æ®µçµ„ï¼ˆåˆ†å‰²ãªã—ï¼‰ ===
                        // æ–‡è„ˆãŒã¤ãªãŒã‚Šã‚„ã™ã„ãŸã‚ã€è¦‹é–‹ãå…¨ä½“ã‚’ä¸€åº¦ã«æ¸¡ã™
                        const base64Data = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        imagesToProcess.push({ name: "è¦‹é–‹ãå…¨ä½“", base64: base64Data });
                    }

                    let pageText = `--- Page ${i} ---\n`;
                    for (const imgData of imagesToProcess) {

                        // Replace prompt placeholder
                        const prompt = OCR_PROMPT.replace('{side}', imgData.name);

                        // === ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ ===
                        let success = false;
                        let maxRetries = 3;
                        for (let attempt = 0; attempt < maxRetries; attempt++) {
                            try {
                                const result = await model.generateContent([{ inlineData: { data: imgData.base64, mimeType: "image/jpeg" } }, prompt]);
                                pageText += result.response.text() + "\n";
                                success = true;
                                break;
                            } catch (err) {
                                const msg = err.message || "";
                                if (msg.includes("429") || msg.includes("RESOURCE_EXHAUSTED")) {
                                    const waitSec = 5 * (attempt + 1);
                                    addLog(`  [!] APIåˆ¶é™ï¼ˆ429ï¼‰ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚${waitSec}ç§’å¾…æ©Ÿã—ã¦å†è©¦è¡Œã—ã¾ã™ (${attempt + 1}/${maxRetries})`, 'retry');
                                    await new Promise(r => setTimeout(r, waitSec * 1000));
                                } else if (msg.includes("503") || msg.includes("UNAVAILABLE")) {
                                    const waitSec = 5 * (attempt + 1);
                                    addLog(`  [!] ã‚µãƒ¼ãƒãƒ¼ãŒä¸€æ™‚çš„ã«æ··é›‘ã—ã¦ã„ã¾ã™ã€‚${waitSec}ç§’å¾…æ©Ÿã—ã¦å†è©¦è¡Œã—ã¾ã™ (${attempt + 1}/${maxRetries})`, 'retry');
                                    await new Promise(r => setTimeout(r, waitSec * 1000));
                                } else if (msg.includes("API_KEY_INVALID") || msg.includes("key is invalid")) {
                                    addLog(`  [x] APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚`, 'error');
                                    break;
                                } else {
                                    addLog(`  [x] ${imgData.name}ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${msg.substring(0, 100)}`, 'error');
                                    break;
                                }
                            }
                        }
                        await new Promise(r => setTimeout(r, 100));
                    }
                    resultArea.value += pageText + "\n";
                    resultArea.scrollTop = resultArea.scrollHeight;
                    addLog(`[${i}/${actualEnd}] å®Œäº†`, 'success');
                }
                addLog("ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", 'success');
            } catch (err) {
                const msg = err.message || "";
                if (msg.includes("API_KEY_INVALID")) {
                    addLog("é‡å¤§ãªã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ãŒæ­£ã—ããªã„ã‹ã€è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", "error");
                } else if (msg.includes("PDF")) {
                    addLog("é‡å¤§ãªã‚¨ãƒ©ãƒ¼: PDFãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", "error");
                } else {
                    addLog("é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + msg, "error");
                }
            } finally {
                const startBtn = document.getElementById('startBtn');
                startBtn.disabled = false;
                startBtn.innerText = "OCRå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹";
                startBtn.style.opacity = "1";
            }
        };

        // Model Custom Input Toggle
        modelSelect.addEventListener('change', (e) => {
            const customInput = document.getElementById('customModelInput');
            if (e.target.value === 'custom') {
                customInput.style.display = 'block';
            } else {
                customInput.style.display = 'none';
            }
        });

    </script>
</body>

</html>
