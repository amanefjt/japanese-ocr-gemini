<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini OCR Web App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background-color: #f5f5f7; color: #1d1d1f; }
        h2 { text-align: center; color: #333; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        strong { display: block; margin-bottom: 10px; color: #0071e3; }
        
        /* æ¡ˆå†…ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .info-box { font-size: 0.9em; line-height: 1.6; color: #515154; margin-bottom: 15px; background: #f9f9fb; padding: 15px; border-radius: 8px; border-left: 4px solid #0071e3; }
        .info-box a { color: #0071e3; font-weight: bold; text-decoration: none; }
        .info-box a:hover { text-decoration: underline; }
        .safe-tag { display: inline-block; background: #34c759; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-bottom: 10px; font-weight: bold; }

        input[type="password"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #d2d2d7; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        button { background-color: #0071e3; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px; transition: background 0.2s; }
        button:hover { background-color: #0077ed; }
        #log { background: #ffffff; color: #333; padding: 15px; border: 1px solid #d2d2d7; border-radius: 8px; font-family: inherit; height: 150px; overflow-y: auto; font-size: 14px; line-height: 1.6; }
        textarea { width: 100%; height: 400px; border: 1px solid #d2d2d7; border-radius: 8px; padding: 15px; font-size: 15px; line-height: 1.8; box-sizing: border-box; margin-top: 10px; }
        .log-error { color: #ff3b30; font-weight: bold; }
        .log-success { color: #34c759; font-weight: bold; }
    </style>
</head>
<body>

    <h2>Gemini OCR</h2>

    <div class="card">
        <strong>1. è¨­å®šï¼ˆAPIã‚­ãƒ¼ï¼‰</strong>
        
        <div class="info-box">
            ğŸ”‘ <strong>APIã‚­ãƒ¼ã®å–å¾—:</strong><br>
            Google AI Studioã§<a href="https://aistudio.google.com/app/apikey" target="_blank">ç„¡æ–™ã®APIã‚­ãƒ¼ã‚’å–å¾—</a>ã§ãã¾ã™ã€‚å¤§é‡ã®PDFã‚’ä¸€åº¦ã«å‡¦ç†ã—ãªã„é™ã‚Šã€ç„¡æ–™ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
        </div>

        <div class="safe-tag">å®‰å…¨æ€§ã«ã¤ã„ã¦</div>
        <div class="info-box" style="border-left-color: #34c759;">
            ğŸ›¡ï¸ å…¥åŠ›ã—ãŸã‚­ãƒ¼ã¯ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆLocalStorageï¼‰ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ä½œè€…ã‚’å«ã‚€ç¬¬ä¸‰è€…ã«é€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€å®‰å¿ƒã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚
        </div>

        <input type="password" id="apiKey" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        <button id="saveKeyBtn">è¨­å®šã‚’ä¿å­˜ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong>2. OCRã‚’å®Ÿè¡Œã™ã‚‹PDFã‚’é¸æŠ</strong>
        <input type="file" id="pdfFile" accept="application/pdf">
        <button id="startBtn">OCRå‡¦ç†ã‚’é–‹å§‹ã™ã‚‹</button>
    </div>

    <div class="card">
        <strong>3. é€²è¡ŒçŠ¶æ³</strong>
        <div id="log">PDFã‚’é¸æŠã—ã¦é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div class="card">
        <strong>4. æ›¸ãèµ·ã“ã—çµæœ</strong>
        <textarea id="result" placeholder="ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const logArea = document.getElementById('log');
        const resultArea = document.getElementById('result');
        const apiKeyInput = document.getElementById('apiKey');

        const addLog = (msg, type = '') => {
            const div = document.createElement('div');
            if (type === 'error') div.className = 'log-error';
            if (type === 'success') div.className = 'log-success';
            div.innerHTML = msg;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        };

        const clearLog = () => { logArea.innerHTML = ""; };

        apiKeyInput.value = localStorage.getItem('gemini_api_key') || "";

        document.getElementById('saveKeyBtn').onclick = () => {
            localStorage.setItem('gemini_api_key', apiKeyInput.value);
            alert("è¨­å®šã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚");
        };

        document.getElementById('startBtn').onclick = async () => {
            const file = document.getElementById('pdfFile').files[0];
            const key = apiKeyInput.value;

            if (!file || !key) {
                alert("PDFãƒ•ã‚¡ã‚¤ãƒ«ã¨APIã‚­ãƒ¼ã®ä¸¡æ–¹ãŒå¿…è¦ã§ã™ã€‚");
                return;
            }

            clearLog();
            addLog(`å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™: ${file.name}`);
            resultArea.value = "";

            try {
                const genAI = new GoogleGenerativeAI(key);
                // æœ€æ–°ã®Flashãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®š
                const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                addLog(`PDFèª­ã¿è¾¼ã¿æˆåŠŸ: å…¨ ${pdf.numPages} ãƒšãƒ¼ã‚¸`);

                for (let i = 1; i <= pdf.numPages; i++) {
                    addLog(`[${i}/${pdf.numPages}] ãƒšãƒ¼ã‚¸ã‚’è§£æä¸­...`);
                    const page = await pdf.getPage(i);
                    // è§£åƒåº¦ã‚’ä¸Šã’ã¦èª­ã¿å–ã‚Šç²¾åº¦ã‚’å‘ä¸Š
                    const viewport = page.getViewport({scale: 2.5});
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({canvasContext: ctx, viewport: viewport}).promise;
                    
                    const mid = canvas.width / 2;
                    const margin = canvas.width * 0.05;
                    const sides = [
                        { name: "å³æ®µ", x: mid - margin, w: mid + margin },
                        { name: "å·¦æ®µ", x: 0, w: mid + margin }
                    ];

                    let pageText = `--- Page ${i} ---\n`;

                    for (const side of sides) {
                        const sCanvas = document.createElement('canvas');
                        sCanvas.width = side.w; sCanvas.height = canvas.height;
                        sCanvas.getContext('2d').drawImage(canvas, side.x, 0, side.w, canvas.height, 0, 0, side.w, canvas.height);
                        
                        const base64Data = sCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                        
                        const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®ç·¨é›†è€…ã§ã™ã€‚ã“ã®ç”»åƒï¼ˆç¸¦æ›¸ãã§ä¸€æ®µçµ„ã€ã¾ãŸã¯äºŒæ®µçµ„ã®${side.name}ï¼‰ã‚’æ­£ç¢ºã«æ›¸ãèµ·ã“ã—ã¦ãã ã•ã„ã€‚ç‰©ç†çš„ãªè¡Œæœ«ã®æ”¹è¡Œã¯ç¹‹ã’ã€æ„å‘³çš„ãªæ®µè½ï¼ˆä¸€æ–‡å­—ä¸‹ã’ç­‰ï¼‰ã®åŒºåˆ‡ã‚Šã ã‘æ”¹è¡Œã—ã¦ãã ã•ã„ã€‚æœ¬æ–‡ã®ã¿å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

                        const result = await model.generateContent([
                            { inlineData: { data: base64Data, mimeType: "image/jpeg" } },
                            prompt
                        ]);

                        pageText += result.response.text() + "\n";
                    }

                    resultArea.value += pageText + "\n";
                    resultArea.scrollTop = resultArea.scrollHeight;
                    addLog(`[${i}/${pdf.numPages}] å®Œäº†`, 'success');

                    await new Promise(r => setTimeout(r, 2000));
                }
                addLog("ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚", 'success');

            } catch (err) {
                addLog("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message, 'error');
                console.error(err);
            }
        };
    </script>
</body>
</html>
